// eval(function(p,a,c,k,e,d){e=function(c){return(c<a?'':e(parseInt(c/a)))+((c=c%a)>35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--){d[e(c)]=k[c]||e(c)}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('3W([\'k\',\'1Q\',\'19/X/a\',\'19/2S/1D\',\'19/2S/D\',\'19/3X/L\',\'19/2i/2R/2y\',\'19/X/P\'],3(k,1Q,a,1D,D,L,2y,P){d 2={};2.2l=3(R){2.2T=R.2T;2.l=R.l;2.z=0;2.18=[];2.r=1;2.28=R.28;2.1l=R.1l;2.1F=R.1F;2.1E=R.1E;2.1d=R.1d;6(!2.1d){12.g({5:$(\'#g\'),2U:{3S:3(){$(\'.V-8\').h();2.2c();2.1J();2.1v()},2m:3(){2.1J();2.1v();2.2e()},2n:3(){2.3a();2.1v()},2k:3(){2.2E()}}})}p{2.2d();12.g({5:$(\'#3T\'),2U:{2m:3(){$(".f-g-1g .g-1g[b-g=\'2m\']").h().2p().F()},2n:3(){$(".f-g-1g .g-1g[b-g=\'2n\']").h().2p().F()},2k:3(){$(".f-g-1g .g-1g[b-g=\'2k\']").h().2p().F();6(!$(\'.1k-8\').v(\'1X\')){$(\'.1k-8\').v(\'1X\',1);2.1e()}}}})}$(\'.2R-22\').c(3(){2.2Q()});2.2Q=3(G){2y.h({1E:2.1E})};2.2c();2.1J();2.1v();$(\'.24-22\').c(3(){2.1G(\'\')});$(\'#T-c\').1O("c",3(){$("#T-a").h()});$(\'.T-m\').1O("c",3(){$("#T-a").F()});$(\'#T-3N\').1O("c",3(){$("#T-a").F()});$(\'#2N-a\').c(3(){2.s=1b 1o({y:$(\'#2N-a-2\').7(),1p:\'a-2\',1m:3(){2.s.m()}});2.s.5.e(\'.1h-Z\').c(3(){2.s.m()});2.s.h()});$(\'#2O-a\').c(3(){2.s=1b 1o({y:$(\'#2O-a-2\').7(),1p:\'a-2\',1m:3(){2.s.m()}});2.s.5.e(\'.1h-Z\').c(3(){2.s.m()});2.s.h()});$(\'#2i-a\').c(3(){2.s=1b 1o({y:$(\'#2i-a-2\').7(),1p:\'a-2\',1m:3(){2.s.m()}});12.3B.2l();2.s.5.e(\'.1h-Z\').c(3(){2.s.m()});2.s.h()});$(".2P-2V .3C").c(3(){d 1j=$(u).b(\'1j\');6(1j==4){2.P(\'D\')}p{2.1G(\'D\')}});$(".2P-2V .3P").c(3(){d 1j=$(u).b(\'1j\');6(1j==4){2.P(\'1I\')}p{2.1G(\'1I\')}});6($(\'#1n-5\').C>0||$(\'#2W-5\').C>0){$(\'.t-33\').1V({34:3(){1A.1t()},2L:3(){1A.1t()}})}p 6($(\'#1n-3O\').C>0||$(\'#2W-5\').C>0){$(\'.t-33\').1V({34:3(){1A.1t()},2L:3(){1A.1t()}})}p 6($(\'.2f-5\').C>0){2.39()}$(\'.1D-14\').c(3(){d U=$(u);6(U.v(\'25\')==\'1\'){S}U.v(\'25\',1);d O=U.v(\'b-O\')==\'1\';d 9=U.e(\'.9\');9.w(\'9-32\').w(\'9-31\');O&&9.A(\'9-32\');!O&&9.A(\'9-31\');U.4d(\'16\');6(!O){9.A(\'2X\').1Y(3(){9.w(\'2X\')})}O=U.v(\'b-O\')==\'1\'?0:1;1D.4r(2.l,O,3(2Y){U.4o(\'25\').v("b-O",2Y?"1":0)})});6(k.4z()){$(\'#1h-2Z\').c(3(){$(\'#27\').4y(4x)});$(\'#27\').c(3(){$(\'#27\').F()})}p{$(\'#1h-2Z\').c(3(){6(k.4c()){S}12.T("请复制链接发送给好友")})}6(2.28){k.1r(\'X/f/4b\',{I:2.l},3(n){d j=n.j;$(".t-9-13[b-Y=\'23\']").e(\'.K\').7(j.K.23);$(".t-9-13[b-Y=\'30\']").e(\'.K\').7(j.K.30);$(".t-9-13[b-Y=\'36\']").e(\'.K\').7(j.K.36);$(".t-9-13[b-Y=\'2F\']").e(\'.K\').7(j.K.2F);$(".t-9-13[b-Y=\'2A\']").e(\'.K\').7(j.K.2A);6(n.1q==1&&j.q.C>0){2.3p();6(!2.1d){$(\'#2z\').h();k.1Q(\'#o-5\',\'4k\',n.j);$(\'#o-5 .t-2I:3e-3d\').c(3(){$("#2z").c()})}$(\'#o-5\').3A()};k.1U(\'#o-5 .3j.15 15\')})}6(!2.1d){$(\'.V-8\').2K({4j:3(){$(".1M-f").7("<i 1N=\'9 9-3h\'></i> <M>释放查看图文详情</M>")},3o:3(){$(".1M-f").7("<i 1N=\'9 9-3g\'></i> <M>上拉查看图文详情</M>");$(\'.V-8\').2K(\'3x\');2.2e();$(\'#g .g.16\').w(\'16\');$(\'#g .g:4g(1)\').A(\'16\')}})}6(4h(11.E)!==\'4B\'){a.4a(11.E)};k.1U(\'.X-2C .t-2C-14 15\');$(".t-2I-4t").c(3(){2.17=1b 1o({y:$(\'#21-a-2\').7(),1p:\'a-2\',1m:3(){2.17.m()}});2.17.5.e(\'.1h-Z\').c(3(){2.17.m()});2.17.h();d B=$("#B").1w();$(".21-14").41(3(){6($(u).1w()==B){$(u).4s("4p","H")}});$(".21-14").1O("c",3(){$.2b({26:k.1y(\'X/f/4m\',{I:$(u).1w()}),2D:H,2J:3(b){b=11.2G.4A(b);6(b.1q>0){$("#B").1w(b.j.I);$("#4v").1R(b.j.4u)}}})})})};2.P=3(G){P.3k({l:2.l,r:2.r,3s:\';\',G:G,z:\'\',3t:H,3u:1i,1P:2.1P,1H:2.1H,3v:3(18){2.18=18;6(G==\'1I\'){P.m();$.2v.2w(k.1y(\'1z/1B\',{I:2.l,4q:1,18:11.2G.47(2.18)}),1i)}p 6(G==\'D\'){D.3K(2.l,2.18,3(n){$(\'.D-14\').e(\'.2q\').7(n.E).w(\'2x\').A(\'J\');11.E=n.E});P.m()}p{P.m()}}})};2.17=3(){2.17=1b 1o({y:$(\'#24-a-2\').7(),1p:\'a-2\',1m:3(){2.3D.m()}})};2.2d=3(){6($(\'.f-8\').e(\'.y-8\').7()!=\'\'){S}12.2B.h(\'3H\');$.2b({26:k.1y(\'X/f/42\',{I:2.l}),2D:H,2J:3(7){12.2B.F();d 35=$(\'.f-8\').2u(\'2j\');$(\'.f-8\').e(\'.y-8\').2u(\'2j\',35).7(7);4n(3(){$(\'.f-8\').3A();$(\'.f-8\').e(\'.y-8\').2u(\'2j\',\'3V\');k.1U(\'.y-8 15\');d $7=$(7).e(\'15\');6($7.C>0){3Z(d i=0,3z=$7.C;i<3z;i++){$7[i].3G=3(){d $u=$(u);d 1c=$u.v(\'b-3w\');6(!$u.v(\'3f-1L\')&&(1c.1Z(\'3I://\')>-1||1c.1Z(\'3M://\')>-1)){d 1L=1c.1Z(2.1l)==-1?1c.3y(2.1F,2.1l):1c.3y(2.1l,2.1F);$u.v(\'b-3w\',1L);$u.v(\'3f-1L\',H)}}}}},2r);6(!2.1d){$(\'.f-8\').3i({4l:3(){$(".1M-V").7("<i 1N=\'9 9-3g\'></i> <M>释放返回商品详情</M>")},4e:3(){$(".1M-V").7("<i 1N=\'9 9-3h\'></i> <M>下拉返回商品详情</M>");$(\'.V-8\').h();$(\'.f-8\').w(\'J\').3i(\'3x\');$(\'#g .g.16\').w(\'16\');$(\'#g .g:3e-3d\').A(\'16\')}})}}})};2.2e=3(){$(\'.V-8\').F();2.2d();$(\'.f-8\').1K(38).A(\'J\').1Y(3(){$(\'.f-8\').1K(\'\')})};2.2c=3(){$(\'.V-8\').h();$(\'.f-8\').1K(38).w(\'J\').1Y(3(){$(\'.f-8\').1K(\'\')})};2.3a=3(){$(\'.3c-8\').h().A(\'J\')};2.1J=3(){$(\'.3c-8\').w(\'J\')};2.1G=3(G){a.3k({l:2.l,r:2.r,3s:\';\',G:G,z:2.z,3t:H,3u:1i,1P:2.1P,1H:2.1H,3v:3(r,z,3r){2.r=r;2.z=z;$(\'.24-22\').7("已选: 数量x"+r+" "+3r);6(G==\'1I\'){d B=$("#B").1w();6($("#B")&&B==\'\'){12.T("请选择赠品！");$(".a-2").3E()}p{6($(\'.L-5\').C>0){d Q=L.3m(\'.L-5\');6(!Q){S}p{k.1r(\'1z/1B/L\',{I:2.l,Q:Q},3(n){$.2v.2w(k.1y(\'1z/1B\',{I:2.l,z:2.z,r:2.r,3F:n.j.46,B:B}),H)},H,H);a.m()}}p{a.m();$.2v.2w(k.1y(\'1z/1B\',{I:2.l,z:2.z,r:2.r,B:B}),1i)}}}p 6(G==\'D\'){6($(\'.L-5\').C>0){d Q=L.3m(\'.L-5\');6(!Q){S}p{k.1r(\'1z/1B/L\',{I:2.l,Q:Q},3(n){D.3n(2.l,2.z,2.r,Q,3(n){$(\'.D-14\').e(\'.2q\').7(n.E).w(\'2x\').A(\'J\');11.E=n.E})},H,H);a.m()}}p{D.3n(2.l,2.z,2.r,1i,3(n){$(\'.D-14\').e(\'.2q\').7(n.E).w(\'2x\').A(\'J\');11.E=n.E});a.m()}}p{a.m()}}})};2.2E=3(){$(\'.1k-8\').h().A(\'J\').1Y(3(){6(!$(\'.1k-8\').v(\'1X\')){$(\'.1k-8\').v(\'1X\',1);2.1e()}})};2.1v=3(){$(\'.1k-8\').w(\'J\')};2.3p=3(){2.1a=1;2.2g=\'\';2.1W=1;$(\'.t-y\').1C({3o:3(){2.1e()}});6(2.1a==1){2.1e()}};2.1e=3(){$(\'#o-q-5 .y-2o\').F();$(\'#o-q-5 .1C-3U\').h();k.1r(\'X/f/3R\',{I:2.l,3Y:2.1a,Y:2.2g,44:2.1W},3(n){d j=n.j;6(j.r<=0){$(\'#o-q-5 .5\').7(\'\').F();$(\'#o-q-5 .y-2o\').h();$(\'#o-q-5\').1C(\'3l\')}p{$(\'#o-q-5 .5\').h();$(\'#o-q-5 .y-2o\').F();$(\'#o-q-5\').1C(\'2l\');6(j.q.C<=0||j.q.C<j.43){$(\'#o-q-5\').1C(\'3l\')}}2.1W=0;2.1a++;k.1Q(\'#o-q-5 .5\',\'40\',j,2.1a>1);$(\'#o-q-5 .t-9-3q .t-9-13\').3Q(\'c\').c(3(){$(\'#o-q-5 .t-9-3q .t-9-13 M.1R-Z\').w(\'1R-Z\');$(u).e(\'M\').A(\'1R-Z\');2.1a=1;2.1W=1;2.2g=$(u).b(\'Y\');$(\'#o-q-5 .5\').7(\'\');2.1e()});k.1U(\'#o-23 .3j.15 15\')},1i)};2.2H=3(3b){d W=1u(3b);d N=0;d 1s=0;6(W>1f){N=1u(W/1f);W=1u(W%1f);6(N>1f){1s=1u(N/1f);N=1u(N%1f)}}S{\'29\':1s<10?\'0\'+1s:1s,\'2a\':N<10?\'0\'+N:N,\'20\':W<10?\'0\'+W:W}};2.39=3(){d 5=$(\'.2f-5\'),2t=5.b(\'2t\'),2s=5.b(\'2s\'),1q=5.b(\'1q\')||0;$.2b({26:\'../48/49/4i.1r\',4w:3(x){4f=+1b 37(x.3J("37"))/2r;6(1q==0){2.1x=2s}p{2.1x=2t}3L(2.1V);2.2h();2.1V=2.2M()}})};2.2h=3(){2.1x-=1;d 1T=2.2H(2.1x);d 1S=$(\'.2f-5\');1S.e(\'.1n-29\').7(1T.29);1S.e(\'.1n-2a\').7(1T.2a);1S.e(\'.1n-20\').7(1T.20);6(2.1x<=0){1A.1t()}};2.2M=3(){S 45(3(){2.2h()},2r)};S 2});',62,286,'||modal|function||container|if|html|block|icon|picker|data|click|var|find|detail|tab|show||result|core|goodsid|close|ret|comments|else|list|total|salePicker|fui|this|attr|removeClass||content|optionid|addClass|giftid|length|cart|cartcount|hide|action|true|id|in|count|diyform|span|theTime1|isfavorite|wholesalePicker|diyformdata|params|return|alert|self|basic|theTime|goods|level|danger||window|FoxUI|col|item|img|active|giftPicker|buyoptions|biz|commentPage|new|data_lazy|new_temp|getCommentList|60|panel|btn|false|type|comment|attachurl_local|maskClick|time|FoxUIModal|extraClass|status|json|theTime2|reload|parseInt|hideComment|val|lasttime|getUrl|order|location|create|infinite|favorite|coupons|attachurl_remote|optionPicker|backurl|buy|hideParams|transition|src|look|class|on|mustbind|tpl|text|obj|times|showImages|timer|commentCount|loaded|transitionEnd|indexOf|sec|gift|selector|all|option|submit|url|cover|getComments|hour|min|ajax|hideDetail|getDetail|showDetail|seckill|commentLevel|setSeckillTimer|sale|height|tab4|init|tab2|tab3|empty|siblings|badge|1000|endtime|starttime|css|router|load|out|couponpicker|tabcomment|pic|loader|swipe|cache|showComment|bad|JSON|formatSeconds|cell|success|pullToLoading|onStart|setSeckillTimerInterval|city|fullback|bottom|couponPicker|coupon|member|seckillinfo|handlers|buttons|discount|fav|is|share|good|likefill|like|labeltext|onEnd|detailHeight|normal|Date|300|initSeckill|showParams|value|param|child|first|check|fold|unfold|pullToRefresh|remark|open|stop|getData|add|onLoading|initComment|group|optiontitle|split|showConfirm|autoClose|onConfirm|lazy|done|replace|len|lazyload|according|cartbtn|packagePicker|remove|gdid|onerror|mini|http|getResponseHeader|addwholesale|clearInterval|https|mask|presell|buybtn|unbind|get_comment_list|tab1|tabnew|loading|auto|define|plugin|page|for|tpl_goods_detail_comments_list|each|get_detail|pagesize|getcount|setInterval|goods_data_id|stringify|addons|ewei_shopv2|changeCartcount|get_comments|ish5app|toggleClass|onRefresh|currenttime|eq|typeof|map|onLoadingReady|tpl_goods_detail_comments|onRefreshReady|querygift|setTimeout|removeAttr|checked|iswholesale|toggle|prop|giftclick|title|gifttitle|complete|200|fadeIn|isWeixin|parse|undefined'.split('|'),0,{}));

define(['core', 'tpl', 'biz/goods/picker', 'biz/member/favorite', 'biz/member/cart', 'biz/plugin/diyform', 'biz/sale/coupon/couponpicker', 'biz/goods/wholesalePicker'],
function(core, tpl, picker, favorite, cart, diyform, couponpicker, wholesalePicker) {
    var modal = {};
    modal.init = function(params) {
        modal.seckillinfo = params.seckillinfo;
        modal.goodsid = params.goodsid;
        modal.optionid = 0;
        modal.buyoptions = [];
        modal.total = 1;
        modal.getComments = params.getComments;
        modal.attachurl_local = params.attachurl_local;
        modal.attachurl_remote = params.attachurl_remote;
        modal.coupons = params.coupons;
        modal.new_temp = params.new_temp;
        if (!modal.new_temp) {
            FoxUI.tab({
                container: $('#tab'),
                handlers: {
                    tab1: function() {
                        $('.basic-block').show();
                        modal.hideDetail();
                        modal.hideParams();
                        modal.hideComment()
                    },
                    tab2: function() {
                        modal.hideParams();
                        modal.hideComment();
                        modal.showDetail()
                    },
                    tab3: function() {
                        modal.showParams();
                        modal.hideComment()
                    },
                    tab4: function() {
                        modal.showComment()
                    }
                }
            })
        } else {
            modal.getDetail();
            FoxUI.tab({
                container: $('#tabnew'),
                handlers: {
                    tab2: function() {
                        $(".detail-tab-panel .tab-panel[data-tab='tab2']").show().siblings().hide()
                    },
                    tab3: function() {
                        $(".detail-tab-panel .tab-panel[data-tab='tab3']").show().siblings().hide()
                    },
                    tab4: function() {
                        $(".detail-tab-panel .tab-panel[data-tab='tab4']").show().siblings().hide();
                        if (!$('.comment-block').attr('loaded')) {
                            $('.comment-block').attr('loaded', 1);
                            modal.getCommentList()
                        }
                    }
                }
            })
        }
        // $('.coupon-selector').click(function() {
        //     modal.couponPicker()
        // });

        modal.couponPicker = function(action) {
            couponpicker.show({
                coupons: modal.coupons
            })
        };
        modal.hideDetail();
        modal.hideParams();
        modal.hideComment();
        $('.option-selector').click(function() {
            modal.optionPicker('')
        });
        $('#alert-click').on("click",
        function() {
            $("#alert-picker").show()
        });
        $('.alert-close').on("click",
        function() {
            $("#alert-picker").hide()
        });
        $('#alert-mask').on("click",
        function() {
            $("#alert-picker").hide()
        });
        $('#city-picker').click(function() {
            modal.salePicker = new FoxUIModal({
                content: $('#city-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function() {
                    modal.salePicker.close()
                }
            });
            modal.salePicker.container.find('.btn-danger').click(function() {
                modal.salePicker.close()
            });
            modal.salePicker.show()
        });
        $('#fullback-picker').click(function() {
            modal.salePicker = new FoxUIModal({
                content: $('#fullback-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function() {
                    modal.salePicker.close()
                }
            });
            modal.salePicker.container.find('.btn-danger').click(function() {
                modal.salePicker.close()
            });
            modal.salePicker.show()
        });
        $('#sale-picker').click(function() {
            modal.salePicker = new FoxUIModal({
                content: $('#sale-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function() {
                    modal.salePicker.close()
                }
            });
            FoxUI.according.init();
            modal.salePicker.container.find('.btn-danger').click(function() {
                modal.salePicker.close()
            });
            modal.salePicker.show()
        });
        $(".bottom-buttons .cartbtn").click(function() {
            var type = $(this).data('type');
            if (type == 4) {
                modal.wholesalePicker('cart')
            } else {
                modal.optionPicker('cart')
            }
        });
        $(".bottom-buttons .buybtn").click(function() {
            var type = $(this).data('type');
            if (type == 4) {
                modal.wholesalePicker('buy')
            } else {
                modal.optionPicker('buy')
            }
        });
        if ($('#time-container').length > 0 || $('#discount-container').length > 0) {
            $('.fui-labeltext').timer({
                onEnd: function() {
                    location.reload()
                },
                onStart: function() {
                    location.reload()
                }
            })
        } else if ($('#time-presell').length > 0 || $('#discount-container').length > 0) {
            $('.fui-labeltext').timer({
                onEnd: function() {
                    location.reload()
                },
                onStart: function() {
                    location.reload()
                }
            })
        } else if ($('.seckill-container').length > 0) {
            modal.initSeckill()
        }
        $('.favorite-item').click(function() {
            var self = $(this);
            if (self.attr('submit') == '1') {
                return
            }
            self.attr('submit', 1);
            var isfavorite = self.attr('data-isfavorite') == '1';
            var icon = self.find('.icon');
            icon.removeClass('icon-like').removeClass('icon-likefill');
            isfavorite && icon.addClass('icon-like'); ! isfavorite && icon.addClass('icon-likefill');
            self.toggleClass('active');
            if (!isfavorite) {
                icon.addClass('fav').transitionEnd(function() {
                    icon.removeClass('fav')
                })
            }
            isfavorite = self.attr('data-isfavorite') == '1' ? 0 : 1;
            favorite.toggle(modal.goodsid, isfavorite,
            function(is) {
                self.removeAttr('submit').attr("data-isfavorite", is ? "1": 0)
            })
        });
        if (core.isWeixin()) {
            $('#btn-share').click(function() {
                $('#cover').fadeIn(200)
            });
            $('#cover').click(function() {
                $('#cover').hide()
            })
        } else {
            $('#btn-share').click(function() {
                if (core.ish5app()) {
                    return
                }
                FoxUI.alert("请复制链接发送给好友")
            })
        }
        if (modal.getComments) {
            core.json('goods/detail/get_comments', {
                id: modal.goodsid
            },
            function(ret) {
                var result = ret.result;
                $(".fui-icon-col[data-level='all']").find('.count').html(result.count.all);
                $(".fui-icon-col[data-level='good']").find('.count').html(result.count.good);
                $(".fui-icon-col[data-level='normal']").find('.count').html(result.count.normal);
                $(".fui-icon-col[data-level='bad']").find('.count').html(result.count.bad);
                $(".fui-icon-col[data-level='pic']").find('.count').html(result.count.pic);
                if (ret.status == 1 && result.list.length > 0) {
                    modal.initComment();
                    if (!modal.new_temp) {
                        $('#tabcomment').show();
                        core.tpl('#comments-container', 'tpl_goods_detail_comments', ret.result);
                        $('#comments-container .fui-cell:first-child').click(function() {
                            $("#tabcomment").click()
                        })
                    }
                    $('#comments-container').lazyload()
                };
                core.showImages('#comments-container .remark.img img')
            })
        }
        if (!modal.new_temp) {
            $('.basic-block').pullToLoading({
                onLoadingReady: function() {
                    $(".look-detail").html("<i class='icon icon-unfold'></i> <span>释放查看图文详情</span>")
                },
                onLoading: function() {
                    $(".look-detail").html("<i class='icon icon-fold'></i> <span>上拉查看图文详情</span>");
                    $('.basic-block').pullToLoading('done');
                    modal.showDetail();
                    $('#tab .tab.active').removeClass('active');
                    $('#tab .tab:eq(1)').addClass('active')
                }
            })
        }
        if (typeof(window.cartcount) !== 'undefined') {
            picker.changeCartcount(window.cartcount)
        };
        core.showImages('.goods-swipe .fui-swipe-item img');
        $(".fui-cell-giftclick").click(function() {
            modal.giftPicker = new FoxUIModal({
                content: $('#gift-picker-modal').html(),
                extraClass: 'picker-modal',
                maskClick: function() {
                    modal.giftPicker.close()
                }
            });
            modal.giftPicker.container.find('.btn-danger').click(function() {
                modal.giftPicker.close()
            });
            modal.giftPicker.show();
            var giftid = $("#giftid").val();
            $(".gift-item").each(function() {
                if ($(this).val() == giftid) {
                    $(this).prop("checked", "true")
                }
            });
            $(".gift-item").on("click",
            function() {
                $.ajax({
                    url: core.getUrl('goods/detail/querygift', {
                        id: $(this).val()
                    }),
                    cache: true,
                    success: function(data) {
                        data = window.JSON.parse(data);
                        if (data.status > 0) {
                            $("#giftid").val(data.result.id);
                            $("#gifttitle").text(data.result.title)
                        }
                    }
                })
            })
        })
    };
    modal.wholesalePicker = function(action) {
        wholesalePicker.open({
            goodsid: modal.goodsid,
            total: modal.total,
            split: ';',
            action: action,
            optionid: '',
            showConfirm: true,
            autoClose: false,
            mustbind: modal.mustbind,
            backurl: modal.backurl,
            onConfirm: function(buyoptions) {
                modal.buyoptions = buyoptions;
                if (action == 'buy') {
                    wholesalePicker.close();
                    $.router.load(core.getUrl('order/create', {
                        id: modal.goodsid,
                        iswholesale: 1,
                        buyoptions: window.JSON.stringify(modal.buyoptions)
                    }), false)
                } else if (action == 'cart') {
                    cart.addwholesale(modal.goodsid, modal.buyoptions,
                    function(ret) {
                        $('.cart-item').find('.badge').html(ret.cartcount).removeClass('out').addClass('in');
                        window.cartcount = ret.cartcount
                    });
                    wholesalePicker.close()
                } else {
                    wholesalePicker.close()
                }
            }
        })
    };
    modal.giftPicker = function() {
        modal.giftPicker = new FoxUIModal({
            content: $('#option-picker-modal').html(),
            extraClass: 'picker-modal',
            maskClick: function() {
                modal.packagePicker.close()
            }
        })
    };
    modal.getDetail = function() {
        if ($('.detail-block').find('.content-block').html() != '') {
            return
        }
        FoxUI.loader.show('mini');
        $.ajax({
            url: core.getUrl('goods/detail/get_detail', {
                id: modal.goodsid
            }),
            cache: true,
            success: function(html) {
                FoxUI.loader.hide();
                var detailHeight = $('.detail-block').css('height');
                $('.detail-block').find('.content-block').css('height', detailHeight).html(html);
                setTimeout(function() {
                    $('.detail-block').lazyload();
                    $('.detail-block').find('.content-block').css('height', 'auto');
                    core.showImages('.content-block img');
                    var $html = $(html).find('img');
                    if ($html.length > 0) {
                        for (var i = 0,
                        len = $html.length; i < len; i++) {
                            $html[i].onerror = function() {
                                var $this = $(this);
                                var data_lazy = $this.attr('data-lazy');
                                if (!$this.attr('check-src') && (data_lazy.indexOf('http://') > -1 || data_lazy.indexOf('https://') > -1)) {
                                    var src = data_lazy.indexOf(modal.attachurl_local) == -1 ? data_lazy.replace(modal.attachurl_remote, modal.attachurl_local) : data_lazy.replace(modal.attachurl_local, modal.attachurl_remote);
                                    $this.attr('data-lazy', src);
                                    $this.attr('check-src', true)
                                }
                            }
                        }
                    }
                },
                1000);
                if (!modal.new_temp) {
                    $('.detail-block').pullToRefresh({
                        onRefreshReady: function() {
                            $(".look-basic").html("<i class='icon icon-fold'></i> <span>释放返回商品详情</span>")
                        },
                        onRefresh: function() {
                            $(".look-basic").html("<i class='icon icon-unfold'></i> <span>下拉返回商品详情</span>");
                            $('.basic-block').show();
                            $('.detail-block').removeClass('in').pullToRefresh('done');
                            $('#tab .tab.active').removeClass('active');
                            $('#tab .tab:first-child').addClass('active')
                        }
                    })
                }
            }
        })
    };
    modal.showDetail = function() {
        $('.basic-block').hide();
        modal.getDetail();
        $('.detail-block').transition(300).addClass('in').transitionEnd(function() {
            $('.detail-block').transition('')
        })
    };
    modal.hideDetail = function() {
        $('.basic-block').show();
        $('.detail-block').transition(300).removeClass('in').transitionEnd(function() {
            $('.detail-block').transition('')
        })
    };
    modal.showParams = function() {
        $('.param-block').show().addClass('in')
    };
    modal.hideParams = function() {
        $('.param-block').removeClass('in')
    };
    modal.optionPicker = function(action) {
        picker.open({
            goodsid: modal.goodsid,
            total: modal.total,
            split: ';',
            action: action,
            optionid: modal.optionid,
            showConfirm: true,
            autoClose: false,
            mustbind: modal.mustbind,
            backurl: modal.backurl,
            onConfirm: function(total, optionid, optiontitle) {
                modal.total = total;
                modal.optionid = optionid;
                $('.option-selector').html("已选: 数量x" + total + " " + optiontitle);
                if (action == 'buy') {
                    var giftid = $("#giftid").val();
                    if ($("#giftid") && giftid == '') {
                        FoxUI.alert("请选择赠品！");
                        $(".picker-modal").remove()
                    } else {
                        if ($('.diyform-container').length > 0) {
                            var diyformdata = diyform.getData('.diyform-container');
                            if (!diyformdata) {
                                return
                            } else {
                                core.json('order/create/diyform', {
                                    id: modal.goodsid,
                                    diyformdata: diyformdata
                                },
                                function(ret) {
                                    $.router.load(core.getUrl('order/create', {
                                        id: modal.goodsid,
                                        optionid: modal.optionid,
                                        total: modal.total,
                                        gdid: ret.result.goods_data_id,
                                        giftid: giftid
                                    }), true)
                                },
                                true, true);
                                picker.close()
                            }
                        } else {
                            picker.close();
                            $.router.load(core.getUrl('order/create', {
                                id: modal.goodsid,
                                optionid: modal.optionid,
                                total: modal.total,
                                giftid: giftid
                            }), false)
                        }
                    }
                } else if (action == 'cart') {
                    if ($('.diyform-container').length > 0) {
                        var diyformdata = diyform.getData('.diyform-container');
                        if (!diyformdata) {
                            return
                        } else {
                            core.json('order/create/diyform', {
                                id: modal.goodsid,
                                diyformdata: diyformdata
                            },
                            function(ret) {
                                cart.add(modal.goodsid, modal.optionid, modal.total, diyformdata,
                                function(ret) {
                                    $('.cart-item').find('.badge').html(ret.cartcount).removeClass('out').addClass('in');
                                    window.cartcount = ret.cartcount
                                })
                            },
                            true, true);
                            picker.close()
                        }
                    } else {
                        cart.add(modal.goodsid, modal.optionid, modal.total, false,
                        function(ret) {
                            $('.cart-item').find('.badge').html(ret.cartcount).removeClass('out').addClass('in');
                            window.cartcount = ret.cartcount
                        });
                        picker.close()
                    }
                } else {
                    picker.close()
                }
            }
        })
    };
    modal.showComment = function() {
        $('.comment-block').show().addClass('in').transitionEnd(function() {
            if (!$('.comment-block').attr('loaded')) {
                $('.comment-block').attr('loaded', 1);
                modal.getCommentList()
            }
        })
    };
    modal.hideComment = function() {
        $('.comment-block').removeClass('in')
    };
    modal.initComment = function() {
        modal.commentPage = 1;
        modal.commentLevel = '';
        modal.commentCount = 1;
        $('.fui-content').infinite({
            onLoading: function() {
                modal.getCommentList()
            }
        });
        if (modal.commentPage == 1) {
            modal.getCommentList()
        }
    };
    modal.getCommentList = function() {
        $('#comments-list-container .content-empty').hide();
        $('#comments-list-container .infinite-loading').show();
        core.json('goods/detail/get_comment_list', {
            id: modal.goodsid,
            page: modal.commentPage,
            level: modal.commentLevel,
            getcount: modal.commentCount
        },
        function(ret) {
            var result = ret.result;
            if (result.total <= 0) {
                $('#comments-list-container .container').html('').hide();
                $('#comments-list-container .content-empty').show();
                $('#comments-list-container').infinite('stop')
            } else {
                $('#comments-list-container .container').show();
                $('#comments-list-container .content-empty').hide();
                $('#comments-list-container').infinite('init');
                if (result.list.length <= 0 || result.list.length < result.pagesize) {
                    $('#comments-list-container').infinite('stop')
                }
            }
            modal.commentCount = 0;
            modal.commentPage++;
            core.tpl('#comments-list-container .container', 'tpl_goods_detail_comments_list', result, modal.commentPage > 1);
            $('#comments-list-container .fui-icon-group .fui-icon-col').unbind('click').click(function() {
                $('#comments-list-container .fui-icon-group .fui-icon-col span.text-danger').removeClass('text-danger');
                $(this).find('span').addClass('text-danger');
                modal.commentPage = 1;
                modal.commentCount = 1;
                modal.commentLevel = $(this).data('level');
                $('#comments-list-container .container').html('');
                modal.getCommentList()
            });
            core.showImages('#comments-all .remark.img img')
        },
        false)
    };
    modal.formatSeconds = function(value) {
        var theTime = parseInt(value);
        var theTime1 = 0;
        var theTime2 = 0;
        if (theTime > 60) {
            theTime1 = parseInt(theTime / 60);
            theTime = parseInt(theTime % 60);
            if (theTime1 > 60) {
                theTime2 = parseInt(theTime1 / 60);
                theTime1 = parseInt(theTime1 % 60)
            }
        }
        return {
            'hour': theTime2 < 10 ? '0' + theTime2: theTime2,
            'min': theTime1 < 10 ? '0' + theTime1: theTime1,
            'sec': theTime < 10 ? '0' + theTime: theTime
        }
    };
    modal.initSeckill = function() {
        var container = $('.seckill-container'),
        starttime = container.data('starttime'),
        endtime = container.data('endtime'),
        status = container.data('status') || 0;
        $.ajax({
            url: '../addons/ewei_shopv2/map.json',
            complete: function(x) {
                currenttime = +new Date(x.getResponseHeader("Date")) / 1000;
                if (status == 0) {
                    modal.lasttime = endtime
                } else {
                    modal.lasttime = starttime
                }
                clearInterval(modal.timer);
                modal.setSeckillTimer();
                modal.timer = modal.setSeckillTimerInterval()
            }
        })
    };
    modal.setSeckillTimer = function() {
        modal.lasttime -= 1;
        var times = modal.formatSeconds(modal.lasttime);
        var obj = $('.seckill-container');
        obj.find('.time-hour').html(times.hour);
        obj.find('.time-min').html(times.min);
        obj.find('.time-sec').html(times.sec);
        if (modal.lasttime <= 0) {
            location.reload()
        }
    };
    modal.setSeckillTimerInterval = function() {
        return setInterval(function() {
            modal.setSeckillTimer()
        },
        1000)
    };
    return modal
});


 
